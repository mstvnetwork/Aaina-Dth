<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSTV Network | Unified Player</title>
    <script src="https://cdn.jsdelivr.net"></script>
    <style>
        :root { --hulu-green: #90EE90; --bg: #0F1115; --surface: #1A1D20; }
        body { margin: 0; background: var(--bg); color: #E0E0E0; font-family: 'Poppins', sans-serif; overflow-x: hidden; }
        
        .header-section { text-align: center; padding: 40px 20px; }
        .title-3d { font-size: 3.5em; margin: 0; color: #fff; letter-spacing: 2px; text-shadow: 0 4px 8px rgba(0,0,0,0.4); }
        
        .scrolling-container { width: 100%; overflow: hidden; background: var(--surface); padding: 15px 0; margin-bottom: 20px; }
        .ticker { display: inline-flex; white-space: nowrap; animation: scroll 40s linear infinite; color: var(--hulu-green); font-weight: 500; }
        
        .player-wrapper { width: 90%; max-width: 1100px; margin: 0 auto; aspect-ratio: 16/9; background: #000; border-radius: 12px; overflow: hidden; box-shadow: 0 12px 24px rgba(0,0,0,0.6); position: relative; }
        .player-instance { width: 100%; height: 100%; border: none; }
        
        .channel-controls { text-align: center; margin: 30px 0; }
        select { 
            padding: 12px 30px; font-size: 1.1em; background: var(--surface); color: var(--hulu-green); 
            border: 1px solid var(--hulu-green); border-radius: 8px; cursor: pointer; width: 90%; max-width: 450px; 
            appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg xmlns='http://www.w3.org' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2390EE90' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 1em center;
        }

        .ov-title { position: absolute; top: 20px; left: 20px; background: rgba(0,0,0,0.7); padding: 8px 15px; border-radius: 5px; border-left: 4px solid var(--hulu-green); z-index: 10; font-size: 0.9em; }

        @keyframes scroll { 0% { transform: translateX(100vw); } 100% { transform: translateX(-100%); } }
    </style>
</head>
<body>

    <div class="header-section">
        <h1 class="title-3d">MSTV NETWORK</h1>
    </div>

    <div class="scrolling-container">
        <div class="ticker" id="ticker-content">LOADING BROADCAST DATA...</div>
    </div>

    <div class="player-wrapper" id="player-container">
        <div class="ov-title" id="now-playing">INITIALIZING...</div>
        <!-- Players will be injected here dynamically -->
    </div>

    <div class="channel-controls">
        <div class="channel-selector-text">SELECT CHANNEL</div>
        <select id="channel-select" onchange="changeChannel(this.value)"></select>
    </div>

<script>
    const container = document.getElementById("player-container");
    const ticker = document.getElementById("ticker-content");
    const titleDisp = document.getElementById("now-playing");
    const selector = document.getElementById("channel-select");

    let channels = [], currentIdx = 0, currentUrl = "", hlsInstance = null;

    async function init() {
        try {
            const res = await fetch('./playlist.json?v=' + Date.now());
            const data = await res.json();
            channels = data.channels;
            ticker.textContent = data.ticker_text || "";
            
            // Fill Dropdown
            selector.innerHTML = channels.map((ch, i) => `<option value="${i}">${ch.name}</option>`).join('');
            
            syncLoop();
        } catch (e) { titleDisp.textContent = "OFFLINE"; }
    }

    function syncLoop() {
        const ch = channels[currentIdx];
        if (!ch) return;

        const totalDuration = ch.playlist.reduce((a, b) => a + b.duration, 0);
        const elapsed = Math.floor((Date.now() - new Date(ch.start_iso).getTime()) / 1000);
        const loopPos = elapsed % totalDuration;

        let acc = 0;
        for (const item of ch.playlist) {
            if (loopPos < acc + item.duration) {
                const seekTime = loopPos - acc;
                if (currentUrl !== item.url) {
                    currentUrl = item.url;
                    titleDisp.textContent = item.title;
                    loadSource(item.url, seekTime);
                }
                break;
            }
            acc += item.duration;
        }
    }

    function loadSource(url, seek) {
        // CLEANUP: Destroy previous player completely
        if (hlsInstance) hlsInstance.destroy();
        const oldPlayer = container.querySelector(".player-instance");
        if (oldPlayer) oldPlayer.remove();

        // IDENTIFY TYPE
        const ytId = url.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/);

        if (ytId) {
            createIframe(`https://www.youtube.com{ytId[1]}?autoplay=1&mute=1&start=${seek}&controls=0&rel=0`);
        } else if (url.includes(".html") || url.includes("embed")) {
            createIframe(url);
        } else {
            createVideo(url, seek);
        }
    }

    function createIframe(src) {
        const ifr = document.createElement("iframe");
        ifr.className = "player-instance";
        ifr.allow = "autoplay; fullscreen";
        ifr.src = src;
        container.appendChild(ifr);
    }

    function createVideo(url, seek) {
        const vid = document.createElement("video");
        vid.className = "player-instance";
        vid.autoplay = true;
        vid.muted = true;
        vid.playsInline = true;
        container.appendChild(vid);

        if (url.includes(".m3u8")) {
            if (Hls.isSupported()) {
                hlsInstance = new Hls();
                hlsInstance.loadSource(url);
                hlsInstance.attachMedia(vid);
                hlsInstance.on(Hls.Events.MANIFEST_PARSED, () => {
                    vid.currentTime = seek;
                    vid.play();
                });
            } else {
                vid.src = url; // Native Safari
            }
        } else {
            vid.src = url;
            vid.onloadedmetadata = () => { vid.currentTime = seek; vid.play(); };
        }
    }

    function changeChannel(idx) {
        currentIdx = parseInt(idx);
        currentUrl = ""; // Force reload
        syncLoop();
    }

    init();
    setInterval(syncLoop, 4000); // Check for next video in playlist every 4s
    setInterval(init, 60000);    // Refresh JSON every minute
</script>
</body>
</html>
