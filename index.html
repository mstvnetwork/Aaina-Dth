<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MSTV LIVE | REPAIR</title>
<script src="https://cdn.jsdelivr.net"></script>
<style>
    :root { --accent: #ff0000; }
    body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; overflow: hidden; font-family: sans-serif; }
    #player-wrap { position: relative; width: 100vw; height: 100vh; background: #000; }
    video { width: 100%; height: 100%; object-fit: contain; position: absolute; z-index: 1; background: #000; }
    
    .brand { position: absolute; top: 30px; right: 30px; display: flex; flex-direction: column; align-items: flex-end; pointer-events: none; opacity: 0.6; z-index: 10; }
    .brand-name { color: white; font-weight: 900; font-size: 24px; }
    .live-tag { background: var(--accent); color: white; font-size: 10px; padding: 2px 6px; font-weight: bold; border-radius: 2px; }
    
    #status-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 20; visibility: hidden; opacity: 0; transition: 0.3s; }
    #status-overlay.active { visibility: visible; opacity: 1; }
    .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    #ui-layer { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); display: flex; gap: 20px; z-index: 30; opacity: 1; }
    #ui-layer.hidden { opacity: 0; pointer-events: none; }
    .ctrl-btn { background: rgba(20,20,20,0.8); border: 1px solid rgba(255,255,255,0.3); color: white; width: 65px; height: 65px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 26px; backdrop-filter: blur(10px); }
    .hide-cursor { cursor: none !important; }
</style>
</head>
<body oncontextmenu="return false;">

<div id="player-wrap">
    <video id="main-video" playsinline muted autoplay></video>
    <div class="brand"><div class="brand-name">MSTV</div><div class="live-tag">LIVE</div></div>
    <div id="status-overlay">
        <div class="spinner"></div>
        <div id="status-text" style="color: white; font-size: 13px; font-weight: bold;">CONNECTING STREAM...</div>
    </div>
    <div id="ui-layer">
        <button class="ctrl-btn" id="mute-toggle">ðŸ”‡</button>
        <button class="ctrl-btn" id="fs-toggle">â›¶</button>
    </div>
</div>

<script>
const video = document.getElementById('main-video');
const playerWrap = document.getElementById('player-wrap');
const uiLayer = document.getElementById('ui-layer');
const statusOverlay = document.getElementById('status-overlay');
const statusText = document.getElementById('status-text');
const muteBtn = document.getElementById('mute-toggle');
const fsBtn = document.getElementById('fs-toggle');

let currentUrl = "";
let uiTimer;
let hasInteracted = false;
let hls = null;

// ACTION & UI LOGIC
function userActivity() {
    uiLayer.classList.remove('hidden');
    playerWrap.classList.remove('hide-cursor');
    if (hasInteracted) {
        clearTimeout(uiTimer);
        uiTimer = setTimeout(() => {
            uiLayer.classList.add('hidden');
            playerWrap.classList.add('hide-cursor');
        }, 3000);
    }
}

function unlockPlayer() {
    if (!hasInteracted) {
        hasInteracted = true;
        console.log("Player Unlocked");
        ['mousemove', 'touchstart', 'keydown'].forEach(ev => playerWrap.addEventListener(ev, userActivity));
        video.play().catch(() => {});
        userActivity();
    }
}
['mousedown', 'touchstart'].forEach(ev => playerWrap.addEventListener(ev, unlockPlayer, { once: true }));

// HLS RECOVERY LOGIC
function initHls(url, seek) {
    if (hls) hls.destroy();
    
    hls = new Hls({
        enableWorker: true,
        maxBufferLength: 60,
        startLevel: -1,
        liveSyncDurationCount: 3,
        manifestLoadingMaxRetry: 10,
        levelLoadingMaxRetry: 10
    });

    hls.on(Hls.Events.ERROR, (event, data) => {
        console.error("HLS Error:", data.type, data.details);
        if (data.fatal) {
            statusText.innerText = "STREAM ERROR - RECONNECTING...";
            switch(data.type) {
                case Hls.ErrorTypes.NETWORK_ERROR:
                    console.log("Network error - check CORS or internet connection.");
                    hls.startLoad();
                    break;
                case Hls.ErrorTypes.MEDIA_ERROR:
                    console.log("Media error - trying to recover...");
                    hls.recoverMediaError();
                    break;
                default:
                    initHls(url, seek);
                    break;
            }
        }
    });

    hls.loadSource(url);
    hls.attachMedia(video);
    hls.on(Hls.Events.MANIFEST_PARSED, () => {
        video.currentTime = seek;
        video.play().catch(e => console.log("Waiting for interaction to play..."));
        statusOverlay.classList.remove('active');
    });
}

async function sync() {
    try {
        const res = await fetch('./playlist.json?v=' + Date.now());
        const data = await res.json();
        const ch = data.channels[0]; // Fix for Array structure
        
        const total = ch.playlist.reduce((a, b) => a + b.duration, 0);
        const start = new Date(ch.start_iso).getTime();
        const elapsed = Math.floor((Date.now() - start) / 1000);
        const playhead = elapsed % total;

        let acc = 0, active = ch.playlist[0];
        for (const item of ch.playlist) {
            if (playhead < (acc + item.duration)) { active = item; break; }
            acc += item.duration;
        }

        const seek = playhead - acc;

        if (currentUrl !== active.url) {
            currentUrl = active.url;
            statusOverlay.classList.add('active');
            statusText.innerText = "LOADING CHANNEL...";
            
            if (Hls.isSupported()) {
                initHls(active.url, seek);
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = active.url;
                video.currentTime = seek;
                video.play();
            }
        } else {
            // Drift threshold: 15s
            if (Math.abs(video.currentTime - seek) > 15) {
                video.currentTime = seek;
            }
        }
    } catch (e) { 
        console.error("Sync Failure:", e);
        statusText.innerText = "OFFLINE - RETRYING...";
    }
}

muteBtn.onclick = (e) => {
    e.stopPropagation();
    video.muted = !video.muted;
    muteBtn.innerText = video.muted ? "ðŸ”‡" : "ðŸ”Š";
    unlockPlayer();
};

fsBtn.onclick = (e) => {
    e.stopPropagation();
    if (!document.fullscreenElement) playerWrap.requestFullscreen();
    else document.exitFullscreen();
    unlockPlayer();
};

setInterval(sync, 20000);
sync();

video.onwaiting = () => statusOverlay.classList.add('active');
video.onplaying = () => statusOverlay.classList.remove('active');
</script>
</body>
</html>
