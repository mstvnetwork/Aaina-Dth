<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MSTV LIVE | Robotic Sync</title>
    <style>
        :root { --accent: #ff0000; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; overflow: hidden; font-family: sans-serif; }
        #player-wrap { position: relative; width: 100vw; height: 100vh; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: contain; background: #000; pointer-events: none; }
        .brand { position: absolute; top: 30px; right: 30px; display: flex; flex-direction: column; align-items: flex-end; pointer-events: none; opacity: 0.8; z-index: 10; }
        .brand-name { color: white; font-weight: 900; font-size: 24px; letter-spacing: 1px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        .live-tag { background: var(--accent); color: white; font-size: 10px; padding: 2px 6px; font-weight: bold; border-radius: 2px; }
        #status-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.85); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 40; opacity: 0; visibility: hidden; transition: 0.3s; }
        #status-overlay.active { opacity: 1; visibility: visible; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        #ui-layer { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); display: flex; gap: 20px; opacity: 0; transition: 0.4s; z-index: 50; }
        #ui-layer.visible { opacity: 1; }
        .ctrl-btn { background: rgba(30,30,30,0.85); border: 1px solid rgba(255,255,255,0.2); color: white; width: 60px; height: 60px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 24px; backdrop-filter: blur(5px); }
    </style>
</head>
<body oncontextmenu="return false;">

<div id="player-wrap">
    <div class="brand"><div class="brand-name">MSTV</div><div class="live-tag">LIVE</div></div>
    <div id="status-overlay"><div class="spinner"></div><div style="color:white; font-weight:bold; font-size:12px; letter-spacing:1px;">SYNCING LIVE STREAM...</div></div>
    <video id="main-video" playsinline muted autoplay preload="auto"></video>
    <div id="ui-layer">
        <button class="ctrl-btn" id="mute-toggle">ðŸ”‡</button>
        <button class="ctrl-btn" id="fs-toggle">â›¶</button>
    </div>
</div>

<script>
const video = document.getElementById('main-video');
const uiLayer = document.getElementById('ui-layer');
const statusOverlay = document.getElementById('status-overlay');
const muteBtn = document.getElementById('mute-toggle');
const fsBtn = document.getElementById('fs-toggle');

let playlistData = null;
let currentSource = "";
let uiTimer;

// --- ROBOTIC SYNC LOGIC ---
async function fetchAndSync() {
    try {
        // Cache busting: ensure we get the latest data from GitHub instantly
        const response = await fetch('./playlist.json?v=' + Date.now(), { cache: "no-store" });
        playlistData = await response.json();
        calculateLiveState();
    } catch (e) { console.error("Sync Error:", e); }
}

function calculateLiveState() {
    if (!playlistData) return;

    const ch = playlistData.channels;
    const totalDuration = ch.playlist.reduce((acc, item) => acc + item.duration, 0);
    const startEpoch = new Date(ch.start_iso).getTime();
    
    // Calculate exact playhead position since the global start date
    const elapsedTotal = (Date.now() - startEpoch) / 1000;
    const currentLoopPos = elapsedTotal % totalDuration;

    let accumulated = 0;
    let activeItem = ch.playlist[0];

    for (const item of ch.playlist) {
        if (currentLoopPos < (accumulated + item.duration)) {
            activeItem = item;
            break;
        }
        accumulated += item.duration;
    }

    const targetTime = currentLoopPos - accumulated;

    // 1. Switch Video Source if needed
    if (video.src !== activeItem.url) {
        statusOverlay.classList.add('active');
        video.src = activeItem.url;
        video.currentTime = targetTime;
        video.play().catch(() => console.log("Autoplay blocked - awaiting interaction"));
    } 
    
    // 2. Strict Sync Enforcement (0.5s drift tolerance)
    const drift = Math.abs(video.currentTime - targetTime);
    if (drift > 0.5) {
        video.currentTime = targetTime;
    }
}

// --- ROBOTIC GUARDS ---
// Prevent manual seeking - if the user tries to jump, snap back to live
video.addEventListener('seeking', () => {
    if (playlistData) calculateLiveState();
});

// Check sync every 500ms for high precision
setInterval(calculateLiveState, 500);
// Refresh JSON data every 60 seconds for schedule updates
setInterval(fetchAndSync, 60000);

// --- UI LOGIC ---
function showUI() {
    uiLayer.classList.add('visible');
    clearTimeout(uiTimer);
    uiTimer = setTimeout(() => uiLayer.classList.remove('visible'), 3000);
}

document.addEventListener('mousemove', showUI);
document.addEventListener('touchstart', showUI);

muteBtn.onclick = () => {
    video.muted = !video.muted;
    muteBtn.innerText = video.muted ? "ðŸ”‡" : "ðŸ”Š";
};

fsBtn.onclick = () => {
    if (!document.fullscreenElement) document.getElementById('player-wrap').requestFullscreen();
    else document.exitFullscreen();
};

video.onplaying = () => statusOverlay.classList.remove('active');
video.onwaiting = () => statusOverlay.classList.add('active');

// Startup
fetchAndSync();
</script>
</body>
</html>
